<!-- frontend/src/app/components/topics/topic-test.component.html -->
<app-navbar></app-navbar>

<div class="container mt-4" *ngIf="!isLoading">
  <!-- Test Header -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h4><i class="fas fa-file-alt me-2"></i>{{ topic?.name }} - Practice Test</h4>
      <p class="mb-0">Complete all 25 questions to test your knowledge</p>
    </div>
  </div>

  <!-- Test Completed View -->
  <div *ngIf="testCompleted" class="card">
    <div class="card-body text-center">
      <h3 class="text-success">Test Completed!</h3>
      <div class="row mt-4">
        <div class="col-md-3">
          <div class="card bg-light">
            <div class="card-body">
              <h5>Score</h5>
              <h3 class="text-primary">{{ totalScore }}/50</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light">
            <div class="card-body">
              <h5>Accuracy</h5>
              <h3 class="text-info">{{ getAccuracy() }}%</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light">
            <div class="card-body">
              <h5>Time Spent</h5>
              <h3 class="text-warning">{{ getTimeSpent() }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light">
            <div class="card-body">
              <h5>Correct</h5>
              <h3 class="text-success">{{ getCorrectAnswersCount() }}/{{ totalQuestions }}</h3>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-4">
        <button class="btn btn-primary me-2" (click)="retryTest()">
          <i class="fas fa-redo me-1"></i>Retry Test
        </button>
        <button class="btn btn-outline-primary" (click)="backToTopics()">
          <i class="fas fa-arrow-left me-1"></i>Back to Topics
        </button>
      </div>
    </div>
  </div>

  <!-- Test In Progress View -->
  <div *ngIf="!testCompleted" class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Question {{ currentQuestionIndex + 1 }} of {{ totalQuestions }}</h5>
      <div class="d-flex align-items-center">
        <span class="badge bg-primary me-2">Score: {{ score }}</span>
        <span class="badge bg-secondary">Time: {{ getTimeSpent() }}</span>
      </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="card-body">
      <div class="progress mb-4" style="height: 10px;">
        <div class="progress-bar" [style.width]="getProgressPercentage() + '%'"></div>
      </div>

      <!-- Current Question -->
      <div *ngIf="questions.length > 0">
        <div class="question-card mb-4">
          <h5 class="question-text">{{ getCurrentQuestion().question }}</h5>
          
          <!-- MCQ Options -->
          <div *ngIf="getCurrentQuestion().type === 'mcq'" class="options-container">
            <div *ngFor="let option of getCurrentQuestion().options; let i = index" 
                 class="option-item"
                 [class.selected]="getCurrentQuestion().userAnswer === option"
                 [class.correct]="getCurrentQuestion().isAnswered && option === getCurrentQuestion().correctAnswer"
                 [class.incorrect]="getCurrentQuestion().isAnswered && getCurrentQuestion().userAnswer === option && option !== getCurrentQuestion().correctAnswer"
                 (click)="selectAnswer(currentQuestionIndex, option)">
              <span class="option-letter">{{ getOptionLetter(i) }}</span>
              <span class="option-text">{{ option }}</span>
            </div>
          </div>

          <!-- Fill in the Blank -->
          <div *ngIf="getCurrentQuestion().type === 'fillblank'" class="fillblank-container">
            <div class="input-group">
              <input type="text" 
                     class="form-control" 
                     placeholder="Type your answer..."
                     #answerInput
                     (keyup.enter)="submitFillBlankAnswer(answerInput)">
              <button class="btn btn-primary" 
                      (click)="submitFillBlankAnswer(answerInput)"
                      [disabled]="getCurrentQuestion().isAnswered">
                Submit
              </button>
            </div>
          </div>

          <!-- Feedback -->
          <div *ngIf="getCurrentQuestion().isAnswered" class="feedback mt-3">
            <div *ngIf="getCurrentQuestion().isCorrect" class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i>Correct! +{{ getCurrentQuestion().points }} points
            </div>
            <div *ngIf="!getCurrentQuestion().isCorrect" class="alert alert-danger">
              <i class="fas fa-times-circle me-2"></i>Incorrect. The correct answer is: {{ getCurrentQuestion().correctAnswer }}
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="d-flex justify-content-between">
          <button class="btn btn-outline-primary" 
                  (click)="previousQuestion()"
                  [disabled]="currentQuestionIndex === 0">
            <i class="fas fa-arrow-left me-1"></i>Previous
          </button>
          
          <button *ngIf="!isLastQuestion() && !getCurrentQuestion().isAnswered" 
                  class="btn btn-outline-secondary"
                  (click)="nextQuestion()">
            Skip <i class="fas fa-arrow-right ms-1"></i>
          </button>
          
          <button *ngIf="isLastQuestion() && getCurrentQuestion().isAnswered" 
                  class="btn btn-success"
                  (click)="completeTest()">
            Complete Test <i class="fas fa-check ms-1"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="isLoading" class="text-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-3">Loading test questions...</p>
</div>